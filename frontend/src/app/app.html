<app-header />

<main class="w-full max-w-screen-xl mx-auto flex flex-col min-h-[calc(100vh-64px)] pb-32 pt-6 px-4">

  @if (messages().length === 0) {
  <div class="flex flex-col items-center justify-center flex-grow text-center text-zinc-500 opacity-60 mt-10">
    <div class="mb-4 p-4 rounded-full bg-zinc-100 dark:bg-zinc-800">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="m12 19 7-7 3 3-7 7-3-3z" />
        <path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
        <path d="m2 2 7.586 7.586" />
        <circle cx="11" cy="11" r="2" />
      </svg>
    </div>
    <p class="text-lg font-medium">Inizia a disegnare con l'IA</p>
  </div>
  }

  <!-- Messages List -->
  <div class="flex flex-col w-full">
    @for (msg of messages(); track msg.id) {
    <app-chat-message [message]="msg" (draw)="handleDraw($event)"></app-chat-message>
    }

    <!-- Loading Skeleton -->
    @if (isLoading()) {
    <div class="flex gap-4 max-w-[90%] md:max-w-[80%] mb-6">
      <!-- Avatar -->
      <div
        class="shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold animate-pulse">
        AI
      </div>

      <div class="flex flex-col gap-3 w-full max-w-sm">
        <!-- Text Skeleton -->
        <div class="flex space-x-2 bg-zinc-100 dark:bg-zinc-800 px-5 py-4 rounded-2xl rounded-tl-sm shadow-sm w-fit">
          <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
          <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
          <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce"></div>
        </div>

        <!-- Image Skeleton -->
        <div
          class="relative w-full aspect-[3/2] bg-zinc-200 dark:bg-zinc-800 rounded-xl overflow-hidden animate-pulse border border-zinc-200 dark:border-zinc-700 shadow-sm">
          <div class="absolute inset-0 flex items-center justify-center text-zinc-400 dark:text-zinc-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="opacity-20">
              <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
              <circle cx="9" cy="9" r="2" />
              <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
            </svg>
          </div>
        </div>
      </div>
    </div>
    }
  </div>

</main>

<app-chat-input (send)="handleSend($event)"></app-chat-input>

<!-- Pre-flight Modal -->
@if (showDrawModal()) {
<div class="fixed inset-0 z-[100] flex items-center justify-center p-4">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" (click)="closeModal()"></div>

  <!-- Modal Card -->
  <div
    class="relative w-full max-w-md bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl overflow-hidden border border-zinc-200 dark:border-zinc-800 animate-in fade-in zoom-in-95 duration-200">

    <!-- Decor Header -->
    <div class="h-2 w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

    <div class="p-8">
      <div class="text-center mb-8">
        <h2
          class="text-2xl font-bold bg-gradient-to-br from-zinc-900 to-zinc-600 dark:from-white dark:to-zinc-400 bg-clip-text text-transparent">
          Prima di iniziare
        </h2>
        <p class="text-zinc-500 dark:text-zinc-400 text-sm mt-2">
          Verifica che il plotter sia pronto per la stampa
        </p>
      </div>

      <div class="space-y-4 mb-8">
        <!-- Step 1 -->
        <div
          class="flex items-center gap-4 p-4 rounded-2xl bg-zinc-50 dark:bg-zinc-800/50 border border-zinc-100 dark:border-zinc-800">
          <div
            class="shrink-0 w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2v4" />
              <path d="m16.2 7.8 2.9-2.9" />
              <path d="M18 12h4" />
              <path d="m16.2 16.2 2.9 2.9" />
              <path d="M12 18v4" />
              <path d="m7.8 16.2-2.9 2.9" />
              <path d="M6 12H2" />
              <path d="m7.8 7.8-2.9-2.9" />
              <circle cx="12" cy="12" r="3" />
            </svg>
          </div>
          <div class="flex flex-col">
            <span class="font-medium text-zinc-900 dark:text-zinc-100">Accendi il plotter</span>
            <span class="text-xs text-zinc-500">Assicurati che sia collegato</span>
          </div>
        </div>

        <!-- Step 2 -->
        <div
          class="flex items-center gap-4 p-4 rounded-2xl bg-zinc-50 dark:bg-zinc-800/50 border border-zinc-100 dark:border-zinc-800">
          <div
            class="shrink-0 w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
              <line x1="3" x2="21" y1="9" y2="9" />
              <line x1="9" x2="9" y1="21" y2="9" />
            </svg>
          </div>
          <div class="flex flex-col">
            <span class="font-medium text-zinc-900 dark:text-zinc-100">Posiziona foglio nuovo</span>
            <span class="text-xs text-zinc-500">Allinealo correttamente</span>
          </div>
        </div>
      </div>

      <div class="flex gap-3">
        <button (click)="closeModal()"
          class="flex-1 px-4 py-3 rounded-xl font-medium text-zinc-700 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
          Annulla
        </button>
        <button (click)="confirmDraw()"
          class="flex-1 px-4 py-3 rounded-xl font-medium text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-lg shadow-indigo-500/20 transition-all active:scale-[0.98]">
          Avvia Macchina
        </button>
      </div>
    </div>
  </div>
</div>
}